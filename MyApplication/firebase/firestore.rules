rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() { return request.auth != null; }

    match /users/{uid} {
      allow read: if true;
      allow write: if isSignedIn() && request.auth.uid == uid;
    }

    match /userIds/{handle} {
      allow read: if true;
      allow create: if isSignedIn() && !exists(/databases/$(database)/documents/userIds/$(handle)) &&
                    request.resource.data.uid == request.auth.uid;
      allow delete: if isSignedIn() && resource.data.uid == request.auth.uid;
      allow update: if false;
    }

    match /displayNames/{nameLc} {
      allow read: if true;
      allow create: if isSignedIn() && !exists(/databases/$(database)/documents/displayNames/$(nameLc)) &&
                    request.resource.data.uid == request.auth.uid;
      allow delete: if isSignedIn() && resource.data.uid == request.auth.uid;
      allow update: if false;
    }

    match /follows/{uid}/following/{other} {
      allow read: if isSignedIn();
      allow write: if isSignedIn() && request.auth.uid == uid;
    }
    match /follows/{uid}/followers/{other} {
      allow read: if isSignedIn();
      allow write: if isSignedIn() && request.auth.uid == other; // owner of write is follower
    }

    match /conversations/{cid} {
      allow read: if isSignedIn() && (request.auth.uid in resource.data.participants);
      allow write: if false; // updated only by message writes (merge in client)

      match /messages/{mid} {
        allow read: if isSignedIn() && (request.auth.uid in get(/databases/$(database)/documents/conversations/$(cid)).data.participants);
        allow create: if isSignedIn() && canSendMessage($(cid));
        allow update, delete: if false;
      }
    }

    function canSendMessage(cid) {
      let conv = get(/databases/$(database)/documents/conversations/$(cid)).data;
      return (request.auth.uid in conv.participants) && followGate(conv.participants);
    }

    function followGate(parts) {
      return parts.size() == 2 && (
        (parts[0] == request.auth.uid && exists(/databases/$(database)/documents/follows/$(request.auth.uid)/following/$(parts[1]))) ||
        (parts[1] == request.auth.uid && exists(/databases/$(database)/documents/follows/$(request.auth.uid)/following/$(parts[0])))
      );
    }
  }
}
